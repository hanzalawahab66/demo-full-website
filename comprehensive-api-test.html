<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { margin: 5px; padding: 10px 15px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .test-section h3 { margin-top: 0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Comprehensive API Test</h1>
    
    <div class="test-section">
        <h3>1. JWT Token Generation</h3>
        <button onclick="generateValidToken()">Generate Valid JWT Token</button>
        <button onclick="testTokenStructure()">Test Token Structure</button>
        <textarea id="tokenDisplay" readonly placeholder="Generated token will appear here..."></textarea>
    </div>

    <div class="test-section">
        <h3>2. Authentication Tests</h3>
        <button onclick="testLogin()">Test Login with Test Seller</button>
        <button onclick="testLoginWithRealUser()">Test Login with Real User</button>
        <button onclick="checkStoredToken()">Check Stored Token</button>
    </div>

    <div class="test-section">
        <h3>3. API Endpoint Tests</h3>
        <button onclick="testMyListings()">Test /my-listings</button>
        <button onclick="testMyListingsWithStoredToken()">Test /my-listings with Stored Token</button>
        <button onclick="testAllEndpoints()">Test All Endpoints</button>
    </div>

    <div class="test-section">
        <h3>4. Server Health</h3>
        <button onclick="testServerHealth()">Test Server Health</button>
        <button onclick="testCORS()">Test CORS</button>
    </div>

    <div class="test-section">
        <h3>5. Controls</h3>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="exportResults()">Export Results</button>
    </div>
    
    <div id="results"></div>

    <script>
        let currentToken = null;
        let testResults = [];

        function addResult(message, type = 'info', data = null) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            
            if (data) {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                div.appendChild(pre);
            }
            
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            
            testResults.push({ timestamp, message, type, data });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }

        function exportResults() {
            const blob = new Blob([JSON.stringify(testResults, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'api-test-results.json';
            a.click();
        }

        // JWT Token Generation
        async function createJWT(payload, secret) {
            const header = { "alg": "HS256", "typ": "JWT" };
            const encodedHeader = btoa(JSON.stringify(header)).replace(/[=]/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const encodedPayload = btoa(JSON.stringify(payload)).replace(/[=]/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const data = encodedHeader + '.' + encodedPayload;
            
            const encoder = new TextEncoder();
            const key = await crypto.subtle.importKey('raw', encoder.encode(secret), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
            const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(data));
            const encodedSignature = btoa(String.fromCharCode(...new Uint8Array(signature))).replace(/[=]/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            return data + '.' + encodedSignature;
        }

        async function generateValidToken() {
            const payload = {
                id: 9999999999999,
                email: 'testseller@example.com',
                role: 'seller',
                iat: Math.floor(Date.now() / 1000),
                exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60)
            };

            try {
                const JWT_SECRET = 'dev-secret-change-me';
                currentToken = await createJWT(payload, JWT_SECRET);
                document.getElementById('tokenDisplay').value = currentToken;
                addResult('âœ… Valid JWT token generated', 'success', { payload, tokenLength: currentToken.length });
            } catch (error) {
                addResult(`âŒ Error generating token: ${error.message}`, 'error');
            }
        }

        function testTokenStructure() {
            if (!currentToken) {
                addResult('âŒ No token to test. Generate one first.', 'error');
                return;
            }

            const parts = currentToken.split('.');
            if (parts.length !== 3) {
                addResult(`âŒ Invalid token structure. Expected 3 parts, got ${parts.length}`, 'error');
                return;
            }

            try {
                const header = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                addResult('âœ… Token structure is valid', 'success', { header, payload, signatureLength: parts[2].length });
            } catch (error) {
                addResult(`âŒ Error parsing token: ${error.message}`, 'error');
            }
        }

        // Authentication Tests
        async function testLogin() {
            addResult('ðŸ”„ Testing login with testseller@example.com...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'testseller@example.com',
                        password: 'secret'
                    })
                });

                const data = await response.json();
                addResult(`Login response (${response.status}):`, response.ok ? 'success' : 'error', data);
                
                if (response.ok && data.token) {
                    localStorage.setItem('token', data.token);
                    addResult('âœ… Token stored in localStorage', 'success');
                }
            } catch (error) {
                addResult(`âŒ Login network error: ${error.message}`, 'error');
            }
        }

        async function testLoginWithRealUser() {
            addResult('ðŸ”„ Testing login with umarmarwat3@gmail.com...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'umarmarwat3@gmail.com',
                        password: '123456'
                    })
                });

                const data = await response.json();
                addResult(`Real user login response (${response.status}):`, response.ok ? 'success' : 'error', data);
            } catch (error) {
                addResult(`âŒ Real user login network error: ${error.message}`, 'error');
            }
        }

        function checkStoredToken() {
            const storedToken = localStorage.getItem('token');
            if (storedToken) {
                addResult('âœ… Found stored token', 'success', { 
                    tokenPreview: storedToken.substring(0, 50) + '...',
                    tokenLength: storedToken.length 
                });
            } else {
                addResult('âŒ No token found in localStorage', 'warning');
            }
        }

        // API Tests
        async function testMyListings() {
            if (!currentToken) {
                addResult('âŒ No generated token. Generate one first.', 'error');
                return;
            }

            addResult('ðŸ”„ Testing /my-listings with generated token...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/my-listings', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                addResult(`/my-listings response (${response.status}):`, response.ok ? 'success' : 'error', data);
            } catch (error) {
                addResult(`âŒ /my-listings network error: ${error.message}`, 'error');
            }
        }

        async function testMyListingsWithStoredToken() {
            const storedToken = localStorage.getItem('token');
            if (!storedToken) {
                addResult('âŒ No stored token found', 'error');
                return;
            }

            addResult('ðŸ”„ Testing /my-listings with stored token...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/my-listings', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${storedToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                addResult(`/my-listings with stored token (${response.status}):`, response.ok ? 'success' : 'error', data);
            } catch (error) {
                addResult(`âŒ /my-listings with stored token network error: ${error.message}`, 'error');
            }
        }

        async function testAllEndpoints() {
            const token = currentToken || localStorage.getItem('token');
            if (!token) {
                addResult('âŒ No token available for testing', 'error');
                return;
            }

            const endpoints = [
                { path: '/my-listings', method: 'GET' },
                { path: '/listings', method: 'GET' },
                { path: '/profile', method: 'GET' }
            ];

            for (const endpoint of endpoints) {
                addResult(`ðŸ”„ Testing ${endpoint.method} ${endpoint.path}...`, 'info');
                
                try {
                    const response = await fetch(`http://localhost:3001${endpoint.path}`, {
                        method: endpoint.method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    addResult(`${endpoint.path} (${response.status}):`, response.ok ? 'success' : 'error', data);
                } catch (error) {
                    addResult(`âŒ ${endpoint.path} network error: ${error.message}`, 'error');
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // Server Health Tests
        async function testServerHealth() {
            addResult('ðŸ”„ Testing server health...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/', {
                    method: 'GET'
                });

                addResult(`Server health (${response.status}): ${response.statusText}`, response.ok ? 'success' : 'warning');
            } catch (error) {
                addResult(`âŒ Server health check failed: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            addResult('ðŸ”„ Testing CORS...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/login', {
                    method: 'OPTIONS'
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                addResult(`CORS test (${response.status}):`, response.ok ? 'success' : 'warning', corsHeaders);
            } catch (error) {
                addResult(`âŒ CORS test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            addResult('ðŸš€ Comprehensive API Test loaded. Ready to test!', 'info');
            checkStoredToken();
        });
    </script>
</body>
</html>