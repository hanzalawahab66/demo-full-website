<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Super Admin Panel — Model Management</title>
  <!-- Page Protection: allow superadmin and listing_editor -->
  <script>
    (function(){
      try {
        var role = (localStorage.getItem('userRole') || localStorage.getItem('role') || '').toLowerCase();
        var token = localStorage.getItem('token');
        var allowed = ['superadmin','listing_editor'];
        if (!token || allowed.indexOf(role) === -1) {
          window.location.href = 'signin.html';
        }
      } catch (e) {
        window.location.href = 'signin.html';
      }
    })();
  </script>
  <style>
    :root {
      --bg: #f6f7fb; --text: #0f172a; --muted: #64748b; --primary: #2563eb; --primary-hover: #1d4ed8;
      --topbar-bg: #ffffff; --topbar-border: #e5e7eb; --sidebar-bg: #0b1220; --sidebar-border: #1f2937;
      --sidebar-text: #cbd5e1; --sidebar-hover-bg: #111827; --sidebar-active-bg: #1f2937; --card-bg: #ffffff; --card-border: #e5e7eb;
      --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: Inter, Segoe UI, Roboto, Helvetica, Arial, system-ui, -apple-system, sans-serif; }

    .admin-layout { display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px auto; grid-template-areas: "topbar topbar" "sidebar content"; height: 100vh; width: 100%; }
    .topbar { grid-area: topbar; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background: var(--topbar-bg); border-bottom: 1px solid var(--topbar-border); position: sticky; top: 0; z-index: 10; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 600; }
    .brand-logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, var(--primary), #9333ea); }
    .top-actions { display: flex; align-items: center; gap: 8px; }
    .btn-logout { border: 1px solid var(--card-border); background: #fff; color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-logout:hover { background: #f9fafb; }

    .sidebar { grid-area: sidebar; background: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border); color: #fff; padding: 16px 12px; overflow-y: auto; }
    .sidebar-header { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--sidebar-text); margin-bottom: 12px; opacity: 0.9; }
    .menu { display: flex; flex-direction: column; gap: 6px; }
    .menu a { display: flex; align-items: center; gap: 10px; padding: 10px 12px; text-decoration: none; color: var(--sidebar-text); border-radius: 10px; transition: background 160ms ease, color 160ms ease; font-weight: 500; }
    .menu a:hover { background: var(--sidebar-hover-bg); color: #fff; }
    .menu a.active { background: var(--sidebar-active-bg); color: #fff; }
    .menu .icon { width: 18px; height: 18px; border-radius: 4px; background: #334155; flex-shrink: 0; }

    .content { grid-area: content; overflow: auto; padding: 16px; }
    .muted { color: var(--muted); }
    .section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .section h3 { margin: 0 0 8px; }
    .input, .select { width: 100%; padding: 10px 12px; border: 1px solid var(--card-border); border-radius: 8px; font: inherit; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-5 { grid-column: span 5; }
    .col-2 { grid-column: span 2; }
    .actions { display: flex; gap: 8px; }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--card-border); background: #fff; cursor: pointer; }
    .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .toolbar { display: flex; gap: 8px; align-items: center; }
    .table-responsive { overflow: auto; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--card-border); }
    thead th { background: #f9fafb; font-weight: 600; }
    tbody tr:last-child td { border-bottom: none; }
    .footer { margin-top: 12px; color: var(--muted); }
    .help { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="admin-layout">
    <header class="topbar" role="banner">
      <div class="brand" aria-label="Admin brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <span>Super Admin Panel</span>
      </div>
      <div class="top-actions">
        <span class="admin-name">Signed in as <strong>Super Admin</strong></span>
        <button class="btn-logout" onclick="location.href='signin.html'">Logout</button>
      </div>
    </header>

    <aside class="sidebar" role="navigation" aria-label="Admin sidebar">
      <div class="sidebar-header">Main Menu</div>
      <nav class="menu">
        <a href="admin.html" title="Dashboard"><span class="icon"></span> Dashboard</a>
        <a href="user-management.html" title="User Management"><span class="icon"></span> User Management</a>
        <a href="listing-approval.html" title="Listing Approvals"><span class="icon"></span> Listing Approvals</a>
        <a href="create-listing.html" title="Create New Listing"><span class="icon"></span> Create New Listing</a>
        <a href="category-management.html" title="Category Management"><span class="icon"></span> Category Management</a>
        <a href="model-management.html" title="Model Management" class="active"><span class="icon"></span> Model Management</a>
        <a href="tag-management.html" title="Tag Management"><span class="icon"></span> Tag Management</a>
        <a href="blog-management.html" title="Blog Management"><span class="icon"></span> Blog Management</a>
        <a href="role-management.html" title="Role Management"><span class="icon"></span> Role Management</a>
        <a href="setting.html" title="Setting"><span class="icon"></span> Setting</a>
      </nav>
    </aside>

    <main class="content" role="main">
      <h1>Model Management</h1>
      <p class="muted">Create, edit, and delete car models. These populate dropdowns on listing forms.</p>

      <!-- Create / Edit Model -->
      <section class="section" aria-label="Create model">
        <h3>Create New Model</h3>
        <div class="row" style="margin-top: 8px">
          <div class="col-5">
            <label class="help" for="model-name">Model Name</label>
            <input id="model-name" class="input" type="text" placeholder="e.g. Corolla, Civic, Camry" />
          </div>
          <div class="col-5">
            <label class="help" for="model-slug">Slug</label>
            <input id="model-slug" class="input" type="text" placeholder="auto-generated from name" />
          </div>
          <div class="col-2" style="display:flex;align-items:end;">
            <button id="add-model" class="btn btn-primary">Add Model</button>
          </div>
        </div>
        <p class="help" style="margin-top:8px">Slug auto-generates from name; you may override.</p>
      </section>

      <!-- Models Table -->
      <section class="section" aria-label="Models table">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <h3 style="margin:0">All Models</h3>
          <div class="toolbar">
            <input id="model-search" class="input" type="search" placeholder="Search by name or slug" style="width:280px" />
            <button id="export-json" class="btn">Export JSON</button>
            <button id="refresh-models" class="btn">Refresh</button>
          </div>
        </div>
        <div class="table-responsive" style="margin-top:8px">
          <table class="table" aria-label="Models table">
            <thead>
              <tr>
                <th style="width:10%">ID</th>
                <th style="width:35%">Name</th>
                <th style="width:35%">Slug</th>
                <th style="width:20%">Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="models-tbody"></tbody>
          </table>
        </div>
      </section>

      <footer class="footer">© 2024 NSM Autos Admin</footer>
    </main>

    <script>
      // Active link highlighting
      (function () {
        var links = document.querySelectorAll('.sidebar .menu a');
        var current = location.pathname.split('/').pop().toLowerCase();
        links.forEach(function (link) {
          var href = link.getAttribute('href') || '';
          if (href.toLowerCase() === current) link.classList.add('active');
        });
      })();

      // Model manager: uses backend routes
      (function () {
        var API = 'http://localhost:3000';
        var state = { models: [], filtered: [] };
        var tbody = document.getElementById('models-tbody');
        var nameEl = document.getElementById('model-name');
        var slugEl = document.getElementById('model-slug');
        var searchEl = document.getElementById('model-search');

        function toSlug(str) {
          return String(str || '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '')
            .replace(/-{2,}/g, '-');
        }

        function renderRows(items) {
          tbody.innerHTML = (items || []).map(function (m) {
            var created = m.created_at ? new Date(m.created_at).toLocaleString() : '—';
            return (
              '<tr data-id="' + m.id + '">' +
                '<td>' + m.id + '</td>' +
                '<td>' + escapeHtml(m.name) + '</td>' +
                '<td>' + escapeHtml(m.slug) + '</td>' +
                '<td>' + created + '</td>' +
                '<td class="actions">' +
                  '<button class="btn" data-action="edit" title="Edit model">Edit</button>' +
                  '<button class="btn" data-action="delete" title="Delete model">Delete</button>' +
                '</td>' +
              '</tr>'
            );
          }).join('');
        }

        function escapeHtml(str) {
          var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
          return String(str || '').replace(/[&<>"]/g, function (m) { return map[m] || m; });
        }

        function applyFilter() {
          var q = (searchEl.value || '').toLowerCase().trim();
          if (!q) {
            state.filtered = state.models.slice();
          } else {
            state.filtered = state.models.filter(function (m) {
              return String(m.name || '').toLowerCase().includes(q) || String(m.slug || '').toLowerCase().includes(q);
            });
          }
          renderRows(state.filtered);
        }

        function addModel() {
          var name = (nameEl.value || '').trim();
          var slug = (slugEl.value || '').trim() || toSlug(name);
          if (!name) { alert('Please enter a model name'); return; }
          if (!slug) { alert('Please enter or confirm a slug'); return; }
          var token = localStorage.getItem('token');
          if (!token) { alert('Please sign in to add models.'); window.location.href='signin.html'; return; }
          fetch(API + '/admin/models', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ name: name, slug: slug })
          }).then(function(r){
            if(!r.ok) return r.json().catch(function(){ return {}; }).then(function(err){ throw new Error(err.error || ('HTTP '+r.status)); });
            return r.json();
          }).then(function(out){
            var model = out && out.data ? out.data : out;
            if (!model || !model.id) { alert('Model created but response was unexpected.'); init(); return; }
            state.models.unshift(model);
            nameEl.value=''; slugEl.value='';
            applyFilter();
          }).catch(function(err){ alert('Add failed: '+err.message); });
        }

        function getTokenOrRedirect() {
          var token = localStorage.getItem('token');
          if (!token) { alert('Please sign in to manage models.'); window.location.href='signin.html'; return null; }
          return token;
        }

        tbody.addEventListener('click', function (e) {
          var btn = e.target.closest('button');
          if (!btn) return;
          var action = btn.getAttribute('data-action');
          var row = btn.closest('tr');
          var id = Number(row.getAttribute('data-id'));
          var model = state.models.find(function (m) { return Number(m.id) === id; });
          if (!model) return;
          if (action === 'delete') {
            if (!confirm('Are you sure?')) return;
            var token = getTokenOrRedirect();
            if (!token) return;
            fetch(API + '/admin/models/' + id, {
              method: 'DELETE',
              headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + token }
            }).then(function(r){
              if(!r.ok) return r.json().catch(function(){ return {}; }).then(function(err){ throw new Error(err.error || ('HTTP '+r.status)); });
              return r.json();
            }).then(function(){
              state.models = state.models.filter(function (m) { return Number(m.id) !== id; });
              applyFilter();
            }).catch(function(err){ alert('Delete failed: ' + err.message); });
          } else if (action === 'edit') {
            var newName = prompt('Enter new model name', model.name || '');
            if (newName == null) return; // user cancelled
            newName = String(newName || '').trim();
            if (!newName) { alert('Model name cannot be empty'); return; }
            var token = getTokenOrRedirect();
            if (!token) return;
            fetch(API + '/admin/models/' + id, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': 'Bearer ' + token },
              body: JSON.stringify({ name: newName })
            }).then(function(r){
              if(!r.ok) return r.json().catch(function(){ return {}; }).then(function(err){ throw new Error(err.error || ('HTTP '+r.status)); });
              return r.json();
            }).then(function(updated){
              var idx = state.models.findIndex(function (m) { return Number(m.id) === id; });
              if (idx !== -1) {
                state.models[idx].name = (updated && updated.name) ? updated.name : newName;
                state.models[idx].slug = (updated && updated.slug) ? updated.slug : toSlug(newName);
              }
              applyFilter();
            }).catch(function(err){ alert('Edit failed: ' + err.message); });
          }
        });

        document.getElementById('add-model').addEventListener('click', addModel);
        document.getElementById('refresh-models').addEventListener('click', init);
        document.getElementById('export-json').addEventListener('click', function () {
          try {
            var blob = new Blob([JSON.stringify(state.models, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href = url; a.download = 'models-export.json'; a.click();
            setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
          } catch (e) { console.warn('Export failed', e); }
        });

        searchEl.addEventListener('input', applyFilter);
        nameEl.addEventListener('input', function () { if (!slugEl.value) slugEl.value = toSlug(nameEl.value); });

        async function init() {
          try {
            var res = await fetch(API + '/public/models', { headers: { 'Accept': 'application/json' } });
            var data = await res.json().catch(function(){ return []; });
            state.models = Array.isArray(data) ? data : [];
          } catch (_) {
            try {
              var res2 = await fetch('/backend/models.json', { headers:{ 'Accept':'application/json' } });
              var data2 = await res2.json().catch(function(){ return []; });
              state.models = Array.isArray(data2) ? data2 : [];
            } catch (e2) {
              state.models = [];
            }
          }
          applyFilter();
        }

        init();
      })();
    </script>
  </div>
</body>
</html>