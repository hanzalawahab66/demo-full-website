<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Listings - NSM Autos</title>
  <!-- Page Protection: redirect non-sellers to signin -->
  <script>
    (function () {
      try {
        var role = localStorage.getItem('userRole') || localStorage.getItem('role');
        if (role !== 'seller') {
          window.location.href = 'signin.html';
        }
      } catch (e) {
        window.location.href = 'signin.html';
      }
    })();
  </script>
  <!-- Tailwind CDN script (avoids blocked CSS fetch) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { heading: ['Inter','sans-serif'], body: ['Inter','sans-serif'] }
        }
      }
    };
  </script>
  <script>window.FontAwesomeConfig = {autoReplaceSvg: 'nest'};</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Removed external Google Fonts to avoid net::ERR_ABORTED in preview env -->
  <style>
    ::-webkit-scrollbar { display: none; }
    * { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif; }
    .status-pill { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-pending { background-color: #FEF3C7; color: #92400E; }
    .status-approved { background-color: #DCFCE7; color: #166534; }
    .status-rejected { background-color: #FEE2E2; color: #991B1B; }
  </style>
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <a href="home.html" class="flex items-center space-x-2">
        <span class="text-2xl font-extrabold text-black tracking-wide">NSM</span>
        <span class="text-2xl font-extrabold" style="color:#FF8C42">Autos</span>
      </a>
      <nav class="flex items-center space-x-6">
        <a href="home.html" class="text-sm font-medium text-gray-700 hover:text-black">Home</a>
        <a href="inventory.html" class="text-sm font-medium text-gray-700 hover:text-black">Buy My Car</a>
        <a href="about-us.html" class="text-sm font-medium text-gray-700 hover:text-black">About Us</a>
        <a href="contact-us.html" class="text-sm font-medium text-gray-700 hover:text-black">Contact Us</a>
      </nav>
    </div>
  </header>
</head>
<body class="bg-gray-50">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-900">My Listings</h1>
      <a href="sell-my-car.html" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium bg-white text-gray-700 hover:bg-gray-100">
        <i class="fa-solid fa-plus mr-2"></i> New Listing
      </a>
    </div>

    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Car</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chassis No.</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Submitted</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="listings-tbody" class="bg-white divide-y divide-gray-200">
            <!-- Rows inserted dynamically -->
          </tbody>
        </table>
      </div>
      <div id="empty-state" class="px-6 py-4 text-sm text-gray-600 hidden">No listings found yet.</div>
      <div id="error-state" class="px-6 py-4 text-sm text-red-600 hidden"></div>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-sm text-gray-600 flex items-center justify-between">
      <span>Â© 2025 NSM Autos</span>
      <div class="space-x-4">
        <a href="about-us.html" class="hover:text-black">About</a>
        <a href="contact-us.html" class="hover:text-black">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const tbody = document.getElementById('listings-tbody');
      const emptyState = document.getElementById('empty-state');
      const errorState = document.getElementById('error-state');

      function formatStatus(s){
        const v = String(s || '').toLowerCase();
        if (v === 'approved') return '<span class="status-pill status-approved">Approved</span>';
        if (v === 'rejected') return '<span class="status-pill status-rejected">Rejected</span>';
        return '<span class="status-pill status-pending">Pending</span>';
      }

      function formatDate(d){
        try {
          return new Date(d).toLocaleString();
        } catch (_) { return d || '-'; }
      }

      function rowHTML(item){
        const car = item.carLabel || '-';
        const chassis = (function(){
          try{
            const v = (item.vehicle && (item.vehicle.chassisNumber || item.vehicle.chassis_number)) || item.chassisNumber || item.chassis_number || '';
            return v ? String(v) : '-';
          }catch(_){ return '-'; }
        })();
        const date = formatDate(item.createdAt);
        const status = formatStatus(item.status);
        const id = item.id;
        return `<tr data-row-id="${id}">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${chassis}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${date}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${status}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="inline-flex items-center px-3 py-1 rounded-md bg-red-600 text-white hover:bg-red-700" data-action="remove" data-id="${id}">
              <i class="fa-solid fa-trash mr-2"></i>Remove
            </button>
            <a class="inline-flex items-center px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 ml-2" href="edit-listing.html?id=${id}" data-action="edit" data-id="${id}">
              <i class="fa-solid fa-pencil mr-2"></i>Edit
            </a>
          </td>
        </tr>`;
      }

      async function load(){
        const token = localStorage.getItem('token');
        if (!token){ window.location.href = 'signin.html'; return; }
        try{
          const res = await fetch('http://localhost:3000/my-listings',{
            method:'GET',
            headers:{ 'Accept':'application/json', 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json().catch(()=>({listings:[]}));
          if(!res.ok){ throw new Error(data.error || `Request failed: ${res.status}`); }
          const list = Array.isArray(data.listings) ? data.listings : [];
          if (list.length === 0){ emptyState.classList.remove('hidden'); return; }
          tbody.innerHTML = list.map(rowHTML).join('');
        }catch(err){
          errorState.textContent = err.message || 'Error loading listings';
          errorState.classList.remove('hidden');
        }
      }

      // Actions: Remove/Delete with confirmation, Edit navigates via link
      tbody.addEventListener('click', async function(e){
        const el = e.target.closest('[data-action]');
        if (!el) return;
        const action = el.getAttribute('data-action');
        const id = el.getAttribute('data-id');
        if (!id) return;
        if (action === 'remove') {
          const ok = confirm('Are you sure you want to remove this listing?');
          if (!ok) return;
          const token = localStorage.getItem('token');
          if (!token) { window.location.href = 'signin.html'; return; }
          try{
            const res = await fetch(`http://localhost:3000/listings/${encodeURIComponent(id)}`, {
              method: 'DELETE',
              headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` }
            });
            const out = await res.json().catch(()=>({}));
            if (!res.ok) { throw new Error(out.error || `Delete failed: ${res.status}`); }
            const row = tbody.querySelector(`tr[data-row-id="${CSS.escape(String(id))}"]`) || el.closest('tr');
            if (row) row.remove();
            if (!tbody.children.length) emptyState.classList.remove('hidden');
          }catch(err){
            alert(err.message || 'Failed to remove listing');
          }
        } else if (action === 'edit') {
          // Link navigates; no extra JS required here.
        }
      });

      (function(){
        var btn = document.getElementById('signout');
        if (btn) {
          btn.addEventListener('click', function(){
            try { localStorage.removeItem('token'); localStorage.removeItem('role'); localStorage.removeItem('user'); } catch(_){}
            window.location.href = 'signin.html';
          });
        }
      })();

      load();
    })();
  </script>
</body>
</html>